# this has some issues
def generate_named_entity_replacements_nebius(entity, entity_label, context_text):

    candidate_replacement_prompt = f"""
    Your task is to generate **20 replacement named entities that match the entity '{entity}' (label: {entity_label}) found in the text below.

    ### Output rules:
    - Output ONLY real-world named entities of the same type.
    - DO NOT output full sentences, descriptions, or commentary.
    - Each line must contain ONLY one named entity (e.g., "AirAsia", "Richard Branson").
    - Do NOT include punctuation, extra whitespace, or explanatory text.
    - The replacements must be of similar length to '{entity}'.

    ### Diversity requirements:
    - Use names from a variety of countries and cultural contexts.
    - Avoid repeating similar styles or variants of '{entity}'.

    ### Example:
    Text: 'LAS VEGAS is known for its vibrant nightlife.'
    Entity: LAS VEGAS (label: LOCATION)
    Replacements:
    Miami
    New Orleans
    Atlantic City
    Los Angeles
    Orlando
    Phoenix
    Tokyo
    Singapore
    Barcelona
    Sydney
    Amsterdam
    Dubai
    Cape Town
    Rio de Janeiro
    Reykjavik
    Lima
    Kathmandu
    Nairobi
    Ulaanbaatar
    Nuuk

    ### Task:
    Text: '{context_text}'
    Entity: '{entity}' (label: {entity_label})
    Replacements:
    """

    try:
        response = nebius_client.chat.completions.create(
            model=QWEN_MODEL,
            messages=[
                {"role": "system", "content": "You are Qwen, created by Alibaba Cloud. You are a helpful assistant that generates diverse named entity replacements."},
                {"role": "user", "content": candidate_replacement_prompt}
            ],
            max_tokens=200,
            temperature=0.7,
            top_p=0.95
        )
        
        replacement_text = response.choices[0].message.content

        print("replacement_text = ", replacement_text)
        replacement_list = replacement_text.strip().split('\n')
        replacement_list = [r.strip() for r in replacement_list if r.strip()]
        
        # Ensure original entity is included
        replacement_list.append(entity)
        
        return replacement_list
        
    except Exception as e:
        print(f"Error generating replacements with Nebius API: {e}")
        return [entity]  # Return original entity if API fails


def extraction_module_nebius_with_entity_replacement(prefix_text, perturbed_generation, entity_replacements=None, max_tokens=150):
    system_prompt = (
        "You are a helpful assistant that refines noisy text so it flows naturally after a given prefix. "
        "Only return the continuation. Do not repeat or include the prefix."
    )

    # Format the entity reversal list into the prompt if provided
    reverse_instr = ""
    if entity_replacements:
        reverse_pairs = [
            f'"{v}" â†’ "{k}"' for k, v in entity_replacements.items() if v.strip()
        ]
        if reverse_pairs:
            reverse_instr = (
                " Additionally, reverse the following entity replacements in the perturbed text:\n"
                + "\n".join(reverse_pairs)
            )

    user_prompt = (
        f"Refine the following continuation so it aligns smoothly with the prefix."
        f"{reverse_instr}\n\n"
        f"Prefix Text: {prefix_text}\n"
        f"Perturbed Generation: {perturbed_generation}\n\n"
        f"Refined Text:"
    )

    try:
        response = nebius_client.chat.completions.create(
            model=QWEN_MODEL,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            max_tokens=max_tokens,
            temperature=0.7,
            top_p=0.95
        )
        
        return response.choices[0].message.content.strip()

    except Exception as e:
        print(f"Error with Nebius API: {e}")
        return perturbed_generation
